# netscream 

#### Facebook 2019

### Условия задания

Дано три файла: [bin](bin), [enc](enc) и [d](d). В задаче упоминается константа, включенная в эту схему шифрования.
 
Требуется получить флаг.

### Уязвимость

После реверса бинарного файла обнаруживается несколько важных фактов:
1.	Проверка функции `ECC_initialization()`, эллиптической кривой была инициализирована с помощью функции [OpenSSL]
(https://www.openssl.org/docs/man1.1.0/man3/EC_GROUP_new_by_curve_name.html),
`EC_GROUP_new_by_curve_name(415LL)`. Число 415 [указывает](http://wooya.me/tldextract-rs/src/openssl_sys/lib.rs.html#318), что используемой кривой является кривая NID_X9_62_prime256v1,
 которая также называется кривой NIST P-256 или secp256r1. Параметры кривой `a`, `b`, `p` и генератор `G` приведены в [SEC2-Ver-1.0.pdf](SEC2-Ver-1.0.pdf).
 Кроме того, точка `P`, используемая для генерации случайных чисел эллиптической кривой, также инициализируется двумя 
 предварительно определенными координатами.
2.	Функция `ECC_RNG()` генерирует и сохраняет 30 байтов, выполняет некоторую логику и затем сохраняет 
еще 2 байта. Из этого выясняется, что функция реализует `Dual_EC_DRBG`,  ранее считавшийся криптографически 
стойким генератор псевдослучайных чисел. 
3.	PRNG генерирует следующие 32 байта, используя их в качестве ключа AES256 для шифрования флага в
 режиме блочного шифрования IGE. Результат шифрования записывается в enc, в результате чего конечный размер файла составляет 64 байта
 
В стандарте [NIST SP 800-90A](nistspecialpublication800-90r.pdf), в описании алгоритма Dual_EC_DRBG используются 2 функции: 
- 	`φ(a)` - функция, преобразующая целое число в бинарную последовательность
- 	`x(A)` - функция, возвращающая x-координату точки `A`
Ход работы:
1. Задается случайное значение значение t = randomseed()
2. В цикле производятся операции:
	1.	Вычисляется значение `s = φ ( x ( t * G ) )`
	2.	Вычисляется значение `r = φ ( x ( s * P ) )`
	3.	Обрезаются старшие 2 байта `r`
	4.	Вывод оставшихся 30 байт `r`
	5.	`t = s`

В статье [DualECTLS.pdf](DualECTLS.pdf) описан бэкдор, заключающийся в том, что, зная секретную константу `d`,
 можно определить внутреннее состояние генератора случайных чисел, благодаря связи между генератором и `P`: `G = d * P`.
Т.к. известны 30 младших байтов x-координаты точки `(s * P)`, перебором последних двух байт, можно получить 
y-координаты и проверить, находится ли точка на кривой.  Благодаря свойству ассоциативности скалярного умножения 
в математике эллиптических кривых можно использовать и следующее равенство: `s * d * P = s * G`, поскольку значению `t` присваивается значение `s`.

Расшифровывает AES256: [crypt.py](crypt.py)

Получает флаг: [solve.sage](solve.sage)
